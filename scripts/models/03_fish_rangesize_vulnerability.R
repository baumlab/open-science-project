# Created by James Robinson
# Created on 13-November-2017

#### Question 3
# *Geographic analysis of range distributions - 
#  where are species exported from? 
#  Are small or large range size fishes exported more or less?*

# **Hypotheses**: Positive linear relationship between export occurences and range size, 
#  as species with a larger range size will exported by more countries. 
# However if any species fall of this line they are of interest: 
# 1) smaller range size for volume = high risk; 
# 2) larger range size than volume = low risk?

# **Data**: OBIS range sizes (from this calculated EOO: extent of occurence and AOO (area of occurence)), 

setwd("~/Documents/git_repos/open-science-project")
library("ggplot2"); library(dplyr); library(lme4); library(MuMIn); library(visreg)
library(sjPlot)
library(sjmisc)
#install.packages("visreg")
theme_set(theme_bw())
# clear my environment
rm(list=ls())

source('scripts/functions/scaling_function.R')
source('scripts/functions/plot-cor-functions.R')

trade <- read.csv("data/clean/trade_top100_fishbase_range.csv") 
head(trade)
dim(trade) # 5100, 18
# 100  11
trade$FoodTroph
trade$N


#####################################################################
#VIF FUNCTION.
#To use:  corvif(YourDataFile)
corvif <- function(dataz) {
  dataz <- as.data.frame(dataz)
  
  #vif part
  form    <- formula(paste("fooy ~ ",paste(strsplit(names(dataz)," "),collapse=" + ")))
  dataz   <- data.frame(fooy=1 + rnorm(nrow(dataz)) ,dataz)
  lm_mod  <- lm(form,dataz)
  
  cat("\n\nVariance inflation factors\n\n")
  print(myvif(lm_mod))
}


#Support function for corvif. Will not be called by the user
myvif <- function(mod) {
  v <- vcov(mod)
  assign <- attributes(model.matrix(mod))$assign
  if (names(coefficients(mod)[1]) == "(Intercept)") {
    v <- v[-1, -1]
    assign <- assign[-1]
  } else warning("No intercept: vifs may not be sensible.")
  terms <- labels(terms(mod))
  n.terms <- length(terms)
  if (n.terms < 2) stop("The model contains fewer than 2 terms")
  if (length(assign) > dim(v)[1] ) {
    diag(tmp_cor)<-0
    if (any(tmp_cor==1.0)){
      return("Sample size is too small, 100% collinearity is present")
    } else {
      return("Sample size is too small")
    }
  }
  R <- cov2cor(v)
  detR <- det(R)
  result <- matrix(0, n.terms, 3)
  rownames(result) <- terms
  colnames(result) <- c("GVIF", "Df", "GVIF^(1/2Df)")
  for (term in 1:n.terms) {
    subs <- which(assign == term)
    result[term, 1] <- det(as.matrix(R[subs, subs])) * det(as.matrix(R[-subs, -subs])) / detR
    result[term, 2] <- length(subs)
  }
  if (all(result[, 2] == 1)) {
    result <- data.frame(GVIF=result[, 1])
  } else {
    result[, 3] <- result[, 1]^(1/(2 * result[, 2]))
  }
  invisible(result)
}
#END VIF FUNCTIONS
#####################################################################


############################################################
## Explanatory Variables ###

# Drop NA's from EOO and AOO because some species don't have a range size calculated 
str(trade)
levels(trade$Exporter.Country)
levels(trade$Genus)
trade$AOO # need to remove the NAs

# Remove NA's in EOO and AOO
library(tidyr)
trade.clean <- trade %>% drop_na(EOO)
head(trade.clean)
which(is.na(trade.clean$EOO)) # none have NA
which(is.na(trade.clean$AOO)) # none have NA
which(is.na(trade.clean$FoodTroph)) # lots have NAs
which(is.na(trade.clean$Genus)) # no NA's
which(is.na(trade.clean$Exporter.Country)) # none


dim(trade.clean) # 5049   18
levels(trade.clean$Taxa) # 99 species 
trade.clean$Taxa <- droplevels(trade.clean$Taxa)
levels(trade.clean$Taxa) # still 99 species 


## scaling pred vars: AOO and EOO as proxies for range size 
# so lets try rescaling
pvars <- c("AOO","EOO")

# add back to data
trade.clean[pvars] <- lapply(trade.clean[pvars],scale)
head(trade.clean) # now rescaled 


pdf(file='figures/03_range/explore_range_model_nexportedcountries.pdf')

## check collinearity
temp<-trade.clean %>% select(AOO, EOO)
pairs(na.omit(temp), upper.panel=panel.cor, diag.panel=panel.hist, lower.panel=panel.smooth2) # 0.27

corvif(temp[, c(-3)])# seems ok # 1.078928



# plot number of exporting countries 
ggplot(trade.clean, aes(AOO, N)) + geom_point() + geom_smooth()
ggplot(trade.clean, aes(EOO, N)) + geom_point() + geom_smooth()
############################################################



############################################################
#### Modeling  ####
# Number of exported countries 
head(trade.clean)
# model with everything 
m1<-lmer(N ~  AOO + EOO + (1 | Genus), 
  #+ (1 | Exporter.Country), 
  trade.clean, family="poisson")
summary(m1)

r.squaredGLMM(m1) # random effect is now working because there aren't NA's in genus anymore! 
par(mfrow=c(2,2)); visreg(m1)
plot(m1)

#       R2m       R2c 
# 0.2961109 0.5298854 
# marginal: fixed effects 
# conditional: fixed and random


# Plot the output of the model
sjp.glmer(m1)
sjp.glmer(m1, type="fe")

# Do we want the random effect? When we have the full model we should compare with and without random structure prior to forward variable selection  
############################################################


############################################################
# Model Validation 

dev.off()



pdf(file='figures/03_range/explore_range_model.pdf')
# plot observed relationships 
ggplot(trade.clean, aes(AOO, export)) + geom_point() + geom_smooth()
ggplot(trade.clean, aes(EOO, export)) + geom_point() + geom_smooth()
############################################################
#### Modeling  ####
# Export

# model with everything 
m1<-glmer(export ~  AOO + EOO + (1 | Genus) + (1 | Exporter.Country), trade.clean, family='binomial')
summary(m1)

r.squaredGLMM(m1) # random effect is now working because there aren't NA's in genus anymore! 
par(mfrow=c(2,2)); visreg(m1)
plot(m1)

#        R2m        R2c 
# 0.03678872 0.71604762 
# marginal: fixed effects (lol)
# conditional: fixed and random

# So just having range size (AOO and EOO) is a VERY bad model <5% of variance explained, but exporter country and genus explains alot of variation

# Plot the output of the model
sjp.glmer(m1)
sjp.glmer(m1, type="fe")

# Do we want the random effect? When we have the full model we should compare with and without random structure prior to forward variable selection  
############################################################


############################################################
# Model Validation 

dev.off()


