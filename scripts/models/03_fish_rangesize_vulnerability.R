# Created by James Robinson
# Created on 13-November-2017

#### Question 3
# *Geographic analysis of range distributions - 
#  where are species exported from? 
#  Are small or large range size fishes exported more or less?*

# **Hypotheses**: Positive linear relationship between export occurences and range size, 
#  as species with a larger range size will exported by more countries. 
# However if any species fall of this line they are of interest: 
# 1) smaller range size for volume = high risk; 
# 2) larger range size than volume = low risk?

# **Data**: OBIS range sizes (from this calculated EOO:
  # extent of occurence), 

setwd("~/Documents/git_repos/open-science-project")
library("ggplot2"); library(dplyr); library(lme4); library(MuMIn); library(visreg)
theme_set(theme_bw())
# clear my environment
rm(list=ls())

source('scripts/functions/scaling_function.R')
source('scripts/functions/plot-cor-functions.R')


trade <- read.csv("data/clean/trade_top100_fishbase_eoo.csv") 
trade$StockCode<-NULL; trade$DietTroph<-NULL; trade$DietSeTroph<-NULL
## create dataframe just for top 100 species - no duplicates across countries
trade.sp<- trade %>% distinct(Taxa, Genus, FoodTroph)

## scaling pred vars
scaled<-scaler(trade, ID=c('Exporter.Country', 'Taxa', 'Genus', 'Aquarium', 'export'))

pdf(file='figures/03_rangesize/explore_rangesize_patterns.pdf', height=7, width=11)


## check collinearity
temp<-trade %>% select(EOO, FoodTroph, Vulnerability)
pairs(na.omit(temp), upper.panel=panel.cor, diag.panel=panel.hist, lower.panel=panel.smooth2)


m1<-glmer(export ~  FoodTroph + 
					EOO + 
					Vulnerability + 
					(1 | Genus) + 
					(1 | Exporter.Country), 
					scaled, family='binomial')
summary(m1)
r.squaredGLMM(m1)
par(mfrow=c(3,2)); visreg(m1, type='conditional')

# predictions
newdf<-scaled
newdf$Vulnerability<-mean(newdf$Vulnerability)
newdf$FoodTroph<-mean(newdf$FoodTroph)
newdf$pred<-predict(m1, newdf, type='response')
ggplot(newdf, aes(EOO, pred, col=EOO)) + geom_point() +
			# facet_wrap(~Exporter.Country) +
			labs(x = 'Extent of occurrence', y='Probability of export')



dev.off()