# Created by James Robinson
# Created on 13-November-2017

#### Question 2

# *Are certain trophic levels or functional groups disproportionately targeted by aquarium trade, 
#  and does this pattern vary regionally? * 

# **Hypotheses**: 
#  The planktivores are primarily targeted because of their size (small, 
#  easy to collect many and popular for small aquariums). 

# **Data**: FishBase (89 of our 100 species matched). Provides FoodTL estimates 

setwd("~/Documents/git_repos/open-science-project")
rm(list=ls())
library(ggplot2); library(dplyr); library(lme4); library(MuMIn); library(visreg)
theme_set(theme_bw())
source('scripts/functions/scaling_function.R')
source('scripts/functions/plot-cor-functions.R')

trade <- read.csv('data/clean/trade_top100_fishbase.csv') 
trade$StockCode<-NULL
trade$DietTroph<-NULL



pdf(file='figures/02_trophic/explore_trophic_patterns.pdf', height=7, width=11)


## scaling pred vars
scaled<-scaler(trade, ID=c('Exporter.Country', 'Taxa', 'Genus', 'export'))

## check collinearity
temp<-trade %>% select(FoodTroph, Length, Vulnerability)
pairs(na.omit(temp), upper.panel=panel.cor, diag.panel=panel.hist, lower.panel=panel.smooth2)

# plot observed relationships so we expect model predictions
# trade %>% group_by(Genus, FoodTroph) %>% summarise(sum=sum(export)) %>%
ggplot(trade, aes(FoodTroph, N)) + geom_point() + labs(y="n. species")

# trade %>% group_by(Genus, Vulnerability) %>% summarise(sum=sum(export)) %>%
ggplot(trade, aes(Vulnerability, N)) + geom_point() + labs(y="n. species")



# trade.all <- trade %>% group_by(Genus, Vulnerability, FoodTroph) %>% summarise(sum=sum(export))
scaled<-scaler(trade, ID=c('Taxa', 'Genus', 'N')); dim(scaled)
## Q2A - how are aquarium fish distributed across trophic levels?
# m.null<-glmer(export ~ 1 + (1 | Genus) + (1 | Exporter.Country), trade[!is.na(trade$FoodTroph),], family='binomial')


## Model m1 is flawed - not all species occur in all countries, so many zeroes are misleading
m1<-glmer(N ~  FoodTroph + 
					# Length + 
					Vulnerability + 
					(1 | Genus) ,
					# (1 | Exporter.Country), 
					scaled, family='poisson')
summary(m1)
# P(N) increases with trophic level. But model is terrible (R2 < 10%)
# What are we missing?
r.squaredGLMM(m1)
par(mfrow=c(2,2)); visreg(m1)
	
## improved model: total number of countries exporting each species. 
## ie.. try irrespective of countries 
# ## (maybe add regional random term?)
# m2<-glmer(N ~  FoodTroph + 
# 					# Length + 
# 					Vulnerability + 
# 					(1 | Genus) ,
# 			scaled, family='poisson')
# summary(m2)


# N exporting countries decreases with trophic level. But model is terrible (R2 < 10%)
# What are we missing?
r.squaredGLMM(m2)
par(mfrow=c(2,2)); visreg(m2)

# predictions across FoodTroph
newdf<-scaled
newdf$Vulnerability<-mean(newdf$Vulnerability)
newdf$pred<-predict(m1, newdf, type='response')
ggplot(newdf, aes(FoodTroph, pred, col=Genus)) + geom_point() +
			labs(x = 'Trophic level', y='N. exporting countries')
## across Vulnerability
newdf<-scaled
newdf$FoodTroph<-mean(newdf$FoodTroph)
newdf$pred<-predict(m1, newdf, type='response')
ggplot(newdf, aes(Vulnerability, pred, col=Genus)) + geom_point() +
			labs(x = 'Vulnerability', y='N. exporting countries')



## HIGH TL fish more likely to be exported than low TL fish
## More vulnerable fish more likely to be exported than low vulnerability fish




dev.off()