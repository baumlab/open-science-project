# Created by James Robinson
# Created on 13-November-2017

#### Question 2

# *Are certain trophic levels or functional groups disproportionately targeted by aquarium trade, 
#  and does this pattern vary regionally? * 

# **Hypotheses**: 
#  The planktivores are primarily targeted because of their size (small, 
#  easy to collect many and popular for small aquariums). 

# **Data**: FishBase (89 of our 100 species matched). Provides FoodTL estimates 

setwd("~/Documents/git_repos/open-science-project")
rm(list=ls())
library(ggplot2); library(dplyr); library(lme4); library(MuMIn); library(visreg)
theme_set(theme_bw())
source('scripts/functions/scaling_function.R')
source('scripts/functions/plot-cor-functions.R')

trade <- read.csv('data/clean/trade_top100_fishbase.csv') 
trade$StockCode<-NULL


s<-unique(trade$Taxa[is.na(trade$Genus)])
library(rfishbase)
# Get trophic level 
## this function takes a LONG time to run (> 30 minutes)
fishes <-validate_names(s, limit=1 )
head(fishes)
str(fishes)


pdf(file='figures/02_trophic/explore_trophic_patterns.pdf', height=7, width=11)

## create dataframe just for top 100 species - no duplicates across countries
trade.sp<- trade %>% distinct(Taxa, Genus, FoodTroph)

## scaling pred vars
scaled<-scaler(trade, ID=c('Exporter.Country', 'Taxa', 'Genus', 'export'))

## check collinearity
temp<-trade %>% select(FoodTroph, Length, Vulnerability)
pairs(na.omit(temp), upper.panel=panel.cor, diag.panel=panel.hist, lower.panel=panel.smooth2)

# plot observed relationships so we expect model predictions
trade %>% group_by(Genus, FoodTroph) %>% summarise(sum=sum(export)) %>%
ggplot(aes(FoodTroph, sum)) + geom_point() + labs(y="n. species")

trade %>% group_by(Genus, Vulnerability) %>% summarise(sum=sum(export)) %>%
ggplot(aes(Vulnerability, sum)) + geom_point() + labs(y="n. species")



trade.all <- trade %>% group_by(Genus, Vulnerability, FoodTroph) %>% summarise(sum=sum(export))
trade.all.scaled<-scaler(trade.all, ID=c('Taxa', 'Genus', 'sum'))
## Q2A - how are aquarium fish distributed across trophic levels?
# m.null<-glmer(export ~ 1 + (1 | Genus) + (1 | Exporter.Country), trade[!is.na(trade$FoodTroph),], family='binomial')


## Model m1 is flawed - not all species occur in all countries, so many zeroes are misleading
m1<-glmer(export ~  FoodTroph + 
					# Length + 
					Vulnerability + 
					(1 | Genus) + 
					(1 | Exporter.Country), 
					scaled, family='binomial')
summary(m1)
# P(export) increases with trophic level. But model is terrible (R2 < 10%)
# What are we missing?
r.squaredGLMM(m1)
par(mfrow=c(2,2)); visreg(m1)

## improved model: total number of countries exporting each species. 
## ie.. try irrespective of countries 
## (maybe add regional random term?)
m2<-glmer(sum ~  FoodTroph + 
					# Length + 
					Vulnerability + 
					(1 | Genus) ,
					trade.all.scaled)
summary(m2)

# N exporting countries decreases with trophic level. But model is terrible (R2 < 10%)
# What are we missing?
r.squaredGLMM(m2)
par(mfrow=c(2,2)); visreg(m2)

# predictions
newdf<-trade.all.scaled
newdf$Vulnerability<-mean(newdf$Vulnerability)
newdf$pred<-predict(m2, newdf, type='response')
ggplot(newdf, aes(FoodTroph, pred, col=FoodTroph)) + geom_point() +
			labs(x = 'Trophic level', y='Probability of export')




## HIGH TL fish more likely to be exported than low TL fish

## Q2A - how are aquarium fish traits distributed across trophic levels by region?



dev.off()